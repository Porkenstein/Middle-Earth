# oath of feanor

cb_oath_of_feanor = {
	name = CB_NAME_OATH_OF_FEANOR
	war_name = WAR_NAME_OATH_OF_FEANOR
	sprite = 17
	can_attack_vassals = yes
	truce_days = 365
	allow_distant = yes
    hostile_against_others = yes
    is_permanent = no
    can_ask_to_join_war = yes
	capturing_defender_is_complete_victory = yes
	hostages_block_cb = no

	can_use = {
		ROOT = {
			trait = oath_of_feanor
		}
		FROM = {
			any_realm_character = {
				NOT = { trait = oath_of_feanor } # sons of faenor shouldn't be fighting each other
				has_artifact = silmaril
			}
		}
	}
	can_use_gui = {
		ROOT = {
			trait = oath_of_feanor
		}
		FROM = {
			any_realm_character = {
				NOT = { trait = oath_of_feanor } # sons of faenor shouldn't be fighting each other
				has_artifact = silmaril
			}
		}
	}

	is_valid = {
		ROOT = {
			trait = oath_of_feanor
		}
		FROM = {
			any_realm_character = {
				has_artifact = silmaril
			}
		}
	}

	on_success = {
		any_attacker = {
			limit = {
				character = ROOT
			}
			participation_scaled_prestige = 200
		}

		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = {
				participation_scaled_prestige = 100
			}
		}

		FROM = {
			any_realm_character = { # TODO - make this an event.  If you can't find the silmaril right away, option to destroy the realm by sacking the capital and slaying any who stand in your way!

				any_artifact = {
					limit = {
						artifact_type = silmaril
					}
					transfer_artifact = {
						from = PREV
						to = ROOT
					}
					PREV = { prestige = -100 }
				}
			}
		}
	}

	on_fail = {
		ROOT = { prestige = -100 }
	}

	on_reverse_demand = {
		ROOT = {
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
			ROOT = { prestige = -200 }
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_piety = 100
			participation_scaled_prestige = 200
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = {
				participation_scaled_piety = 100
				participation_scaled_prestige = 200
			}
		}
	}

	attacker_ai_victory_worth = {
		factor = 200
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 100
	}
	ai_will_do = {
		factor = 90
	}
}

cb_war_of_wrath = { # ALL OR NOTHING
	name = CB_NAME_OVERTHROWRULER
	war_name = WAR_NAME_WAR_OF_WRATH
	sprite = 17
	allow_distant = yes
    allow_whitepeace = no
    truce_days = 365
    battle_warscore_mult = 0.0 # slow war
	capturing_defender_is_complete_victory = yes
    can_call_vassals = yes
    can_call_allies = yes
    can_ask_to_join_war = yes
    is_permanent = yes
	hostages_block_cb = no

	can_use = {
		always = no
	}

    is_valid = {
		always = yes
	}

	on_success = {
		# end game event. Beleriand sinks, Morgoth is captured and the silmarils recovered.  Many return with the host to Valinor, but many elect to remain in Eriador.
	}

	on_fail = {
		# end game event. Beleriand sinks, everybody retreats to Eriador and Valinor, Morgoth escapes with the silmarils.
	}

	on_reverse_demand = {
		# end game event.  Beleriand sinks, everybody dies, Morgoth escapes with the silmarils.
	}

	attacker_ai_victory_worth = {
		factor = -1
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1
	}

	defender_ai_defeat_worth = {
		factor = 100
	}
}

# attack dwarf hold and loot its riches
dejure_dwarf_barony_claim = {
	name = CB_NAME_DEJUREBARONYCLAIM
	war_name = WAR_NAME_DEJUREBARONYCLAIM
	sprite = 16
	truce_days = 3650
	hostile_against_others = yes
	is_permanent = yes
	check_de_jure_tier = COUNT
	can_ask_to_join_war = no
	allowed_to_target_tributaries = no
	infamy_modifier = 0.5

	can_use = {
        NOT = { trait = dwarf_friend }
        OR = {
            ai = no
            trait = zealous # I hate dwarves!
            trait = greedy # I want their riches!
            trait = selfish # I want their riches!
            trait = cruel # I'm mean!
            trait = impaler # I'm mean!
            trait = evil_side # I'm mean!
            is_foe = FROM # I hate that dwarf in particular!
        }
        OR = {
            ai = no
            trait = zealous # For my race!
            trait = authoritative # Obey me or die!
            trait = ambitious # What everyone else thinks won't stop my ambition
            trait = evil_side # I need power!
        }
        FROM = { culture_group = culture_group_dwarves } # use dejure_barony_claim cb instead
        NOT = { ROOT = { culture_group = culture_group_dwarves } }

		NOR = {
			ROOT = { religion = religion_wilderness }
			FROM = { religion = religion_wilderness }
		}
		FROM = {
			OR = {
				holy_order = no
				NOT = { religion = ROOT }
				NOT = { has_dlc = "Sons of Abraham" }
			}
		}
	}

	can_use_title = {
		has_holder = yes
		holder_scope = {
			OR = {
				character = ROOT
				is_liege_or_above = ROOT
			}
		}
		any_direct_de_jure_vassal_title = {
			holder_scope = {
				OR = {
					character = FROM
					is_liege_or_above = FROM
				}
				NOR = {
					character = ROOT
					is_liege_or_above = ROOT
				}
			}
		}
	}

	on_success_title = {
        FROM = {
            transfer_scaled_wealth = { # loot the hold
				to = ROOT
				value = 4.0
                min = 20
                max = 200
			}
        }
		holder_scope = {
			save_event_target_as = target_taker
		}

		any_direct_de_jure_vassal_title = {
			limit = {
				holder_scope = {
					OR = {
						character = FROM
						is_liege_or_above = FROM
					}
					NOR = {
						character = event_target:target_taker
						is_liege_or_above = event_target:target_taker
						is_liege_or_above = ROOT
					}
				}
			}

			usurp_title_plus_barony_if_unlanded = { target = event_target:target_taker type = claim }
            location = {
                add_dwarf_ruins = yes # dwarf buildings are destroyed after we take this, looting its wealth
            }
		}

		any_attacker = {
			limit = { character = ROOT }
			participation_scaled_prestige = 50
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	on_fail_title = {
		ROOT = {
			prestige = -50
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 25
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 25 }
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -100
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 50
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}

	attacker_ai_defeat_worth = {
		factor = 75
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 75
	}
}

# attack a kingdom or higher level title.  If win, all of king's personal holdings are ruined and all of his non-county titles are destroyed.
# note that this could be repurposed for the sack of menegroth

cb_destroy_kingdom = {
	name = CB_NAME_DESTROY_KINGDOM
	war_name = WAR_NAME_DESTROY_KINGDOM
	sprite = 37
	truce_days = 365
	hostile_against_others = no
	is_permanent = yes
    allow_distant = yes
    allow_whitepeace = no
	can_ask_to_join_war = yes
	check_de_jure_tier = KING # this scans all de jure kingdoms for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes
	hostages_block_cb = no
	
	can_use = {
		FROM = {
			NOT = { religion = religion_wilderness }
		}
		higher_tier_than = duke
		OR = {
			religion_group=religion_group_melkor
			trait = evil_side
		}
	}
	
	can_use_gui = {
		custom_tooltip = {
			text = broken_siege_of_angband_tip
			hidden_tooltip = {
				OR = {
					ROOT = {
						top_liege = { NOT = { has_character_flag = morgoth } }
					}
					has_global_flag = broken_siege_of_angband # morgoth can't launch invasions until after the bragollach
				}
			}
		}
		ROOT = {
			prestige = 500
		}
		FROM = {
			higher_tier_than = duke
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor } # Should subjugate these instead
			independent = yes
		}
	}
	
	on_add = {
		ROOT = { 
			prestige = -500 
			wealth = 150
			piety = 500
		}
	}

	can_use_title = {
		# kingdom or above can be 'destroyed'
		FROM = {
			primary_title = {
				title = PREVPREV
			}
		}
		NOT = { is_hidden_realm = yes }
	}
	
	is_valid_title = {
		FROM = {
			has_landed_title = PREV
		}
	}

	on_success = {
		ROOT = {
			prestige = 1000
		}
		any_attacker = {
			limit = { character = ROOT }
			participation_scaled_prestige = 200
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}
		
		# destroy capital province
		hidden_tooltip = {
			create_character = {
			  random_traits = no
			  name = "Wilderness"
			  religion = religion_wilderness
			  culture = culture_wilderness
			  dynasty = 19013
			  female = no
			  age = 4000
			  trait = wilderness
			  #disallow_random_traits = yes
			}
			FROM = {

				# capital is looted
				transfer_scaled_wealth = {
					to = ROOT
					value = 4.0
				}
			
				capital_holding = {
					location = {
						ruin_province = yes
					}
					county = {
						new_character = {
							usurp_title = PREV
							set_defacto_liege = THIS
							capital = PREV
						}
						convert_to = CASTLE
						new_character = {
							set_government_type = wilderness_nongovernment
						}
						location = {
							culture = culture_wilderness
							religion = religion_wilderness
						}
					}
				}
			}
		}

		# destroy the kingdom
		FROM = {
		
			# destroy all higher titles
			any_demesne_title = {
				limit = {
					higher_tier_than = count
				}
				destroy_landed_title = THIS
			}
			
			hidden_tooltip = {
			
				# many of the lords die
				any_courtier_or_vassal = {
					random_list = {
						30 = {
							modifier = {
								# fight to the death!
								factor = 2
								trait = brave
							}
							death = {
								death_reason = death_battle
								killer = ROOT
							}
						}
						70 = {
						}
					}
				}
				# the king will probably die
				random_list = {
					70 = {
						modifier = {
							factor = 0.1
							
							# sail away!
							OR = {
								trait = mariner
								trait = navigator
								trait = captain
								trait = ship_builder
							}
						}
						death = {
							death_reason = death_battle
							killer = ROOT
						}
					}
					30 = {
					}
				}
			}
		}
	}
	
	on_success_title = {
	}

	on_fail = {
		FROM = {
			prestige = 100
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
		ROOT = {
			prestige = -200
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 1.0
			}
		}
		FROM = {
			prestige = 200
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 200
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}
		hidden_tooltip = {
			FROM = {
				occupy_minors_of_occupied_settlements = ROOT
				gain_all_occupied_titles = ROOT
			}
		}
	}

	attacker_ai_victory_worth = {
		factor = -1
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 99
	}
	ai_will_do = { 
		factor = 500
	}
}

# set a watch on angband.  Morgoth needs to be contained, let's sever Angband from its dominion

cb_set_watch_on_angband = {
	name = CB_NAME_SET_A_WATCH_ON_ANGBAND
	war_name = WAR_NAME_SET_A_WATCH_ON_ANGBAND
	sprite = 8
	truce_days = 365
	hostile_against_others = no
	is_permanent = yes
    allow_distant = no
    allow_whitepeace = no
	can_ask_to_join_war = yes
	check_de_jure_tier = EMPEROR # this scans all de jure kingdoms for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes
	hostages_block_cb = no
	
	can_use = {
		FROM = {
			religion_group = religion_group_melkor
			completely_controls = c_angband
		}
		ROOT = {
			OR = {
				higher_tier_than = duke
				AND = {
					martial = 40
					higher_tier_than = count
				}
			}
			NOT = { religion_group=religion_group_melkor }
			NOT = { trait = evil_side }
		}
	}

	can_use_gui = {
		custom_tooltip = {
			text = broken_siege_of_angband_tip
			hidden_tooltip = {
				has_global_flag = broken_siege_of_angband # morgoth is not contained!
			}
		}
		ROOT = {
			prestige = 500
		}
	}

	is_valid = {
		always = yes
	}
	is_valid_title = {
		always = yes
	}

	can_use_title = {
		title = e_dor_daedeloth
	}

	on_add = {
		ROOT = {
			prestige = -500
			piety = 500
		}
	}

	on_success = {
		ROOT = {
			prestige = 1000
			piety = 1000
		}
		any_attacker = {
			limit = { character = ROOT }
			participation_scaled_prestige = 200
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}

		# gain ard-galen. the rest are wilderness
		FROM = {
			any_realm_province = {
				limit = {
					NOT = { kingdom = { title = k_angband } }
					NOT = { duchy = { title = d_ard_galen } }
					#NOT = { county = { title = c_minui_edwyn_eryn } }
					#NOT = { county = { title = c_minui_annui_eryn } }
				}
				# abandon the province
				set_province_flag = abandoned_by_morgoth
			}
			any_realm_province = {
				limit = {
					duchy = { title = d_ard_galen }
				}
				county = {
					gain_title = ROOT
				}
			}
		}

		# put a watch on angband
		clr_global_flag = broken_siege_of_angband
		ROOT = {
			save_global_event_target_as  = target_angband_victor
			any_playable_ruler = {
				set_character_flag = notify_clr_broken_siege_of_angband
			}
		}
	}

	on_success_title = {
	}

	on_fail = {
		FROM = {
			prestige = 100
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
		ROOT = {
			prestige = -200
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 1.0
			}
		}
		FROM = {
			prestige = 200
		}
		any_defender = {
			limit = { character = FROM }
			participation_scaled_prestige = 200
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}
		hidden_tooltip = {
			FROM = {
				occupy_minors_of_occupied_settlements = ROOT
				gain_all_occupied_titles = ROOT
			}
		}
	}

	attacker_ai_victory_worth = {
		factor = -1
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 99
	}
	ai_will_do = { 
		factor = 1000
	}
}