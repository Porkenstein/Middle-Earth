# THE DAGOR BRAGOLLACH
# the sudden flame
#

# TODO - 
#  fix dagor_bragollach.10, which seems to be triggering a cascade of dagor_bragollach.13 events
#  figure out why the unit damage is not working
# 

namespace = dagor_bragollach

# The Siege of Angband is broken - AI
narrative_event = {
	id = dagor_bragollach.10
	major = yes
	hide_window = yes

	trigger = {
		has_landed_title = e_dor_daedeloth
		year = 4764
		
		NOT = { has_global_flag = broken_siege_of_angband }
		 
		# only happens randomly if AI
		ai = yes
	}
	
	immediate = {
		set_global_flag = broken_siege_of_angband
	}
	
	mean_time_to_happen = {
		years = 3
	}

	option = {
		slmarillion_sudden_flame_effect = yes
		#18 = {
		#	spawn_unit = {
		#		owner = ROOT
		#		province = THIS
		#		home = THIS
		#		troops = {
		#			archers = { 1500 1500 }
		#			light_infantry = { 10000 10000 } # give the stupid morgoth AI a boost
		#			heavy_infantry = { 2000 2000 }
		#			light_cavalry = { 2000 2000 }
		#			monster_infantry = { 500 500 }
		#			monster_cavalry = { 500 500 }
		#		}
		#		disband_on_peace = no
		#		maintenance_multiplier = 0.1
		#	}
		#}
	}
}

# The Siege of Angband is broken - victim player
narrative_event = {
	id = dagor_bragollach.11
	title = EVTNAME_dagor_bragollach_11
	desc = EVTDESC_dagor_bragollach_11
	major = yes
	
	picture = GFX_anfauglith
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_dagor_bragollach_11
		custom_tooltip = {
			text = EVTOPTA_dagor_bragollach_11_TIP

			any_realm_province = {
				increase_depopulation_effect = yes
			}
			any_unit = {
				damage_unit = {
					percentage = 1.0
				}
			}
		}

		if = {
			limit = {
				has_character_flag = flag_fingolfin
			}

			# the ride of rochallor
			character_event = { id = fingolfin.12 days = 30 }
		}
	}
}

# The Siege of Angband has been placed
narrative_event = {
	id = dagor_bragollach.12
	title = EVTNAME_dagor_bragollach_12
	desc = EVTDESC_dagor_bragollach_12
	hide_from = yes
	major = yes

	picture = GFX_noldor_battle_2
	border = GFX_event_narrative_frame_war

	has_character_flag = notify_clr_broken_siege_of_angband

	mean_time_to_happen = {
		days = 10
	}

	option = {
		trigger = {
			NOT = {
				OR = {
					trait = evil_side
					society_member_of = the_satanists
					religion_group = religion_group_melkor
				}
			}
		}
		name = EVTOPTA_dagor_bragollach_12
		clr_character_flag = notify_clr_broken_siege_of_angband
	}

	option = {
		trigger = {
			has_character_flag=morgoth
		}
		name = EVTOPTB_dagor_bragollach_12

		custom_tooltip = {
			text = EVTOPTB_dagor_bragollach_12_TIP

			clr_character_flag = notify_clr_broken_siege_of_angband
		}
	}

	option = {
		trigger = {
			NOT = { has_character_flag=morgoth }
			OR = {
				trait = evil_side
				society_member_of = the_satanists
				religion_group = religion_group_melkor
			}
		}
		name = EVTOPTC_dagor_bragollach_12
		clr_character_flag = notify_clr_broken_siege_of_angband
	}
}

# The Siege of Angband has been broken
narrative_event = {
	id = dagor_bragollach.13
	title = EVTNAME_dagor_bragollach_13
	desc = EVTDESC_dagor_bragollach_13
	major = yes
	
	picture = GFX_anfauglith
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_dagor_bragollach_13
		trigger = {
			NOT = {
				OR = {
					trait = evil_side
					society_member_of = the_satanists
					religion_group = religion_group_melkor
				}
			}
		}

		if = {
			limit = {
				has_character_flag = flag_fingolfin
			}

			# the ride of rochallor
			character_event = { id = fingolfin.12 days = 30 }
		}
	}

	option = {
		name = EVTOPTB_dagor_bragollach_13
		trigger = {
			OR = {
				trait = evil_side
				society_member_of = the_satanists
				religion_group = religion_group_melkor
			}
		}
	}
}

# The Siege of Angband is broken - Morgoth player
narrative_event = {
	id = dagor_bragollach.14
	title = EVTNAME_dagor_bragollach_14
	desc = EVTDESC_dagor_bragollach_14
	hide_from = yes
	major = yes

	is_triggered_only = yes

	picture = GFX_anfauglith
	border = GFX_event_narrative_frame_war
	
	immediate = {
		set_global_flag = broken_siege_of_angband
	}
	
	option = {
		name = EVTOPTA_dagor_bragollach_14

		slmarillion_sudden_flame_effect = yes
	}
}

# Province is abandoneds by morgoth due to the siege
province_event = {
	id = dagor_bragollach.15
	hide_window = yes

	trigger = {
		has_province_flag = abandoned_by_morgoth
	}
	
	mean_time_to_happen = {
		months = 1
	}

	option = {
		clr_province_flag = abandoned_by_morgoth
		
		abandon_province = yes
	}
}

# angband is under siege!
character_event = {
	id = dagor_bragollach.16
	notification = no
	hide_window = yes

	only_rulers = yes

	trigger = {
		has_global_flag = broken_siege_of_angband
		independent = yes
		is_ruler = yes

		completely_controls = d_ard_galen
		NOR = {
			trait = evil_side
			religion_group = religion_group_melkor
		}
		any_independent_ruler = {
			AND = {
				religion_group = religion_group_melkor
				completely_controls = c_angband
			}
		}
	}

	mean_time_to_happen = {
		days = 10
	}

	option = {
		# this character ended up with a watch on angband!
		prestige = 500
		piety = 500

		any_playable_ruler = {
			limit = {
				completely_controls = c_angband
			}

			# gain ard-galen. the rest are wilderness
			any_realm_province = {
				limit = {
					NOT = { kingdom = { title = k_angband } }
					NOT = { duchy = { title = d_ard_galen } }
				}
				# abandon the province
				set_province_flag = abandoned_by_morgoth
			}
		}

		# put a watch on angband
		clr_global_flag = broken_siege_of_angband
		save_global_event_target_as = target_angband_victor
		any_playable_ruler = {
			set_character_flag = notify_clr_broken_siege_of_angband
		}
	}
}

# morgoth ended up breaking the siege of angband
character_event = {
	id = dagor_bragollach.17
	notification = no
	hide_window = yes

	only_rulers = yes

	trigger = {
		NOT = { has_global_flag = broken_siege_of_angband }
		independent = yes
		is_ruler = yes

		religion_group = religion_group_melkor
		completely_controls = c_angband
		completely_controls = d_ard_galen
		OR = {
			trait = evil_side
			religion_group = religion_group_melkor
		}
	}

	mean_time_to_happen = {
		days = 10
	}

	option = {
		# this character ended breaking the watch on angband!
		prestige = 100
		piety = 100

		# destroy the watch on angband
		set_global_flag = broken_siege_of_angband
		any_player = {
			character_event = { id = dagor_bragollach.18 days = 1 }
			limit = {
				NOT = { character = ROOT }
			}
		}
	}
}


# The Siege of Angband has been broken
narrative_event = {
	id = dagor_bragollach.18
	title = EVTNAME_dagor_bragollach_18
	desc = EVTDESC_dagor_bragollach_18
	major = yes

	is_triggered_only = yes
	
	picture = GFX_anfauglith
	border = GFX_event_narrative_frame_war

	trigger = {
		NOT = { has_character_flag = morgoth }
	}

	option = {
		trigger = {
			NOT = {
				OR = {
					trait = evil_side
					society_member_of = the_satanists
					religion_group = religion_group_melkor
				}
			}
		}
		name = EVTOPTA_dagor_bragollach_18
	}

	option = {
		trigger = {
			OR = {
				trait = evil_side
				society_member_of = the_satanists
				religion_group = religion_group_melkor
			}
		}
		name = EVTOPTB_dagor_bragollach_18
	}
}
