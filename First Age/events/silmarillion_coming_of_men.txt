namespace = comingofmen

# The Awakening of Men
narrative_event = {
	id = comingofmen.1
	title = EVTTITcomingofmen.1
	desc = EVTDESCcomingofmen.1
	picture = GFX_elves_scouting
	hide_from = yes

	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { has_character_flag = morgoth }
			NOT = { religion_group = religion_group_melkor }
		}
		name = EVTOPTAcomingofmen.1
		add_trait = zealous
	}

	option = {
		trigger = {
			NOT = { religion_group = religion_group_melkor }
			NOT = { trait = zealous }
		}
		name = EVTOPTBcomingofmen.1
		random = {
			chance = 10
			add_trait = man_friend
		}
	}

	option = {
		trigger = {
			has_character_flag = morgoth
		}
		name = EVTOPTCcomingofmen.1
		c_10106 = { # Fankil
			letter_event = { id = comingofmen.15 days = 5 }
		}
	}

	option = {
		trigger = {
			NOT = { has_character_flag = morgoth }
		}
		name = EVTOPTDcomingofmen.1
	}
}

# The Forodwaith
narrative_event = {
	id = comingofmen.2
	title = EVTTITcomingofmen.2
	desc = EVTDESCcomingofmen.2
	picture = GFX_edain_settlement

	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { has_character_flag = morgoth }
			NOT = { religion_group = religion_group_melkor }
		}
		name = EVTOPTAcomingofmen.2
		random = {
			chance = 20
			add_trait = zealous
		}
		prestige = 200
	}

	option = {
		trigger = {
			NOT = { religion_group = religion_group_melkor }
			NOT = { trait = zealous }
		}
		name = EVTOPTBcomingofmen.2
		random = {
			chance = 20
			add_trait = man_friend
		}
		piety = 100
	}

	option = {
		trigger = {
			OR = {
				religion_group = religion_group_melkor
				has_character_flag = morgoth
			}
		}
		name = EVTOPTCcomingofmen.2
	}
}

# The Anachrim
narrative_event = {
	id = comingofmen.3
	title = EVTTITcomingofmen.3
	desc = EVTDESCcomingofmen.3
	picture = GFX_evt_abandoned_lands

	is_triggered_only = yes

	trigger = {
		NOT = { religion = religion_lossoth }
	}

	option = {
		name = EVTOPTAcomingofmen.3
	}
}

# The Battle of Palisor
narrative_event = {
	id = comingofmen.4
	title = EVTTITcomingofmen.4
	desc = EVTDESCcomingofmen.4
	picture = GFX_shadows_coming
	hide_from = yes

	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
		}
		name = EVTOPTAcomingofmen.4
		random = {
			chance = 20
			add_trait = stressed
		}
	}

	option = {
		trigger = {
			OR = {
				trait = evil_side
				religion_group = religion_group_melkor
			}
		}
		name = EVTOPTBcomingofmen.4
		prestige = 50
	}

	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
		}
		name = EVTOPTCcomingofmen.4
		random = {
			chance = 20
			add_trait = cynical
		}
		remove_trait = man_friend
	}
}

# The Edain
narrative_event = {
	id = comingofmen.5
	title = EVTTITcomingofmen.5
	desc = EVTDESCcomingofmen.5
	picture = GFX_elves_and_men_2

	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
			NOT = { trait = zealous }
			learning = 14
		}
		name = EVTOPTAcomingofmen.5
		tooltip_info = learning
		custom_tooltip = {
			text = EVTOPTATOOLTIPcomingofmen.5
			# todo try courting the edain
		}
	}

	option = {
		name = EVTOPTBcomingofmen.5
	}

	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
		}
		name = EVTOPTCcomingofmen.5
		prestige = 100
		random = {
			chance = 20
			add_trait = zealous
		}
	}

	option = {
		trigger = {
			OR = {
				trait = evil_side
				religion_group = religion_group_melkor
				trait = zealous
			}
			martial = 14
		}
		name = EVTOPTDcomingofmen.5
		tooltip_info = martial
		custom_tooltip = {
			text = EVTOPTDTOOLTIPcomingofmen.5
			# todo try exterminating the edain
		}
	}
}

# The Easterlings
narrative_event = {
	id = comingofmen.6
	title = EVTTITcomingofmen.6
	desc = EVTDESCcomingofmen.6
	picture = GFX_edain_travel

	is_triggered_only = yes
	
	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
			NOT = { trait = man_friend }
		}
		name = EVTOPTAcomingofmen.6
		random = {
			chance = 20
			add_trait = zealous
		}
		prestige = 200
	}

	option = {
		trigger = {
			NOT = { trait = evil_side }
			NOT = { religion_group = religion_group_melkor }
			NOT = { trait = zealous }
		}
		name = EVTOPTBcomingofmen.6
		random = {
			chance = 20
			add_trait = man_friend
		}
		piety = 50
	}

	option = {
		trigger = {
			OR = {
				religion_group = religion_group_melkor
				trait = evil_side
			}
		}
		name = EVTOPTCcomingofmen.6
	}
}

# announcement of the kingdom of brethil
long_character_event = {
	id = comingofmen.10
	title = EVTTITcomingofmen.10
	desc = EVTDESCcomingofmen.10
	picture = GFX_edain_leader_female

	is_triggered_only = yes

	option = {
		trigger = {
			capital_scope = {
				NOT = { de_jure_liege_or_above = e_eglador }
			}
		}
		name = EVTOPTAcomingofmen.10
	}

	option = {
		trigger = {
			capital_scope = {
				NOT = { de_jure_liege_or_above = e_eglador }
			}
		}
		name = EVTOPTBcomingofmen.10
		random = {
			chance = 20
			add_trait = zealous
		}
	}

	option = {
		trigger = {
			capital_scope = {
				de_jure_liege_or_above = e_eglador
			}
		}
		name = EVTOPTCcomingofmen.10
	}
}

# dan sends a letter
character_event = {
	id = comingofmen.11
	desc = EVTDESCcomingofmen.11
	picture = GFX_elves_scouting

	has_character_flag = flag_dan

	trigger = {
		has_global_flag = coming_of_men_edain
        NOT = { has_global_flag = coming_of_men_letter }
	}

	mean_time_to_happen = {
		years = 10
	}

	option = {
		name = EVTOPTAcomingofmen.11
		c_3146 = { # finrod
			letter_event = { id = comingofmen.14 days = 5 }
		}
	}

	after = {
		set_global_flag = coming_of_men_letter
	}
}

# announcement of a new edain realm
long_character_event = {
	id = comingofmen.13
	title = EVTTITcomingofmen.13
	desc = EVTDESCcomingofmen.13
	picture = GFX_edain_leader
	is_triggered_only = yes

	option = {
		trigger = {
			NOT = {
				any_liege = { character = FROM }
			}
			NOT = {
				any_neighbor_independent_ruler = { character = FROM }
			}
			NOT = {
				has_landed_title = k_doriath
			}
			NOT = {
				has_landed_title = e_eglador
			}
		}
		name = EVTOPTAcomingofmen.13
	}

	option = {
		trigger = {
			NOT = {
				any_liege = { character = FROM }
			}
			NOT = {
				any_neighbor_independent_ruler = { character = FROM }
			}
			NOT = {
				has_landed_title = k_doriath
			}
			NOT = {
				has_landed_title = e_eglador
			}
		}
		name = EVTOPTBcomingofmen.13
		random = {
			chance = 20
			add_trait = zealous
		}
	}

	option = {
		trigger = {
			OR = {
				any_liege = { character = FROM }
				any_neighbor_independent_ruler = { character = FROM }
				has_landed_title = k_doriath
				has_landed_title = e_eglador
			}
		}
		name = EVTOPTCcomingofmen.13
	}
}

# A letter from dan
letter_event = {
	id = comingofmen.14
	desc = EVTDESCcomingofmen.14
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.14

		trigger = {
			OR = {
				ai = no
			 	NOT = { trait = zealous }
			}
		}
		reverse_opinion = { who = FROM modifier = opinion_insulted }
	}
	option = {
		name = EVTOPTBcomingofmen.14

		trigger = {
			OR = {
				ai = no
				NOT = { trait = man_friend }
			}
		}
		reverse_opinion = { who = FROM modifier = opinion_very_grateful }

		# send a letter that pisses off the edain
		random_independent_ruler = {
			limit = {
				culture_group = culture_group_edain
				any_demesne_title = {
					empire = {
						title = e_ossiriand
					}
				}
			}
			letter_event = { id = comingofmen.18 days = 5 }
		}
	}
}

# Invade palisor!
letter_event = {
	id = comingofmen.15
	desc = EVTDESCcomingofmen.15
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.15
		add_trait = at_east
		abdicate = yes # game over!
	}

	after = {
		k_palisor = {
			PREV = {
				usurp_title = PREV
			}
		}
	}
}

# The Awakening of Men - for AI Morgoth
narrative_event = {
	id = comingofmen.16
	hide_window = yes
	has_character_flag = morgoth

	trigger = {
		ai = yes
		has_global_flag = coming_of_men_awakening

        NOT = { has_character_flag = coming_of_men_awakening_ai_morgoth }
	}

	mean_time_to_happen = {
		years = 2
	}

	option = {
		c_10106 = { # Fankil
			letter_event = { id = comingofmen.15 days = 5 }
		}
	}

	after = {
		set_character_flag = coming_of_men_awakening_ai_morgoth
	}
}


# A letter from finrod
letter_event = {
	id = comingofmen.18
	desc = EVTDESCcomingofmen.18
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.18
		remove_trait = elf_friend
		FROM = {
			letter_event = { id = comingofmen.19 days = 5 }
		}
	}
}

# Response from the edain
letter_event = {
	id = comingofmen.19
	desc = EVTDESCcomingofmen.19
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.19
		reverse_opinion = { who = FROM modifier = opinion_insulted }
		remove_trait = man_friend
	}
}

# lord of doriath sends a letter
long_character_event = {
	id = comingofmen.20
	desc = EVTDESCcomingofmen.20
	picture = GFX_elves_scouting

	only_independent = yes
	has_global_flag = coming_of_men_edain

	trigger = {
		OR = {
			has_landed_title = k_doriath
			has_landed_title = e_eglador
		}
        NOT = { has_global_flag = coming_of_men_brethil }

		any_independent_ruler = {
			OR ={
				culture = culture_haladin
				AND = {
					culture_group = culture_group_edain
					year = 4750 # at this point take what we can get
				}
			}
			OR = {
				year = 4720
				capital_scope = {
					empire = {
						NOT = { title = e_ossiriand }
						NOT = { title = e_harn_baland }
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		years = 2
	}

	option = {
		name = EVTOPTAcomingofmen.20
		
		# pick random haladin ruler west of the gelion.
		# note that if the haladin band is enabled, they will likely be picked. Don't enable unless brethil is around.
		random_independent_ruler = {
			limit = {
				OR ={
					culture = culture_haladin
					AND = {
						culture_group = culture_group_edain
						year = 4750 # at this point take what we can get
					}
				}
				capital_scope = {
					empire = {
						NOT = { title = e_ossiriand }
						NOT = { title = e_harn_baland }
					}
				}
			}
			letter_event = { id = comingofmen.21 }
		}
	}
	option = {
		trigger = {
			ai = no
		}
		name = EVTOPTBcomingofmen.20
	}
}

letter_event = {
	id = comingofmen.21
	desc = EVTDESCcomingofmen.21
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.21

		add_trait = elf_friend
		
		hidden_tooltip = {
			if = {
				limit = {
					c_amon_obel = {
						is_not_player_capital_county = yes
					}
				}
				c_amon_obel = {
					PREV = {
						grant_title_no_opinion = PREV
					}
					location = {
						build_city_effect = yes
					}
				}
			}
			if = {
				limit = { 
					c_eryn_en_haladin = {
						is_not_player_capital_county = yes
					}
				}
				c_eryn_en_haladin = {
					PREV = {
						grant_title_no_opinion = PREV
					}
					location = {
						build_city_effect = yes
					}
				}
			}
			if = {
				limit = { 
					c_angbor = {
						is_not_player_capital_county = yes
					}
				}
				c_angbor = {
					PREV = {
						grant_title_no_opinion = PREV
					}
					location = {
						build_temple_effect = yes
					}
				}
			}
			if = {
				limit = { 
					c_brethil = {
						is_not_player_capital_county = yes
					}
				}
				c_brethil = {
					PREV = {
						grant_title_no_opinion = PREV
					}
					location = {
						build_city_effect = yes
					}
				}
			}

			# give province to druedain
			create_character = {
				name="Aghân"
				dynasty=15001
				religion=religion_druedain
				culture=culture_druedain
			}
			new_character = {
				if = {
					limit = { 
						c_eithel_celebros = {
							is_not_player_capital_county = yes
						}
					}
					c_eithel_celebros = {
						PREV = {
							grant_title_no_opinion = PREV
						}
						location = {
							build_city_effect = yes
						}
					}
				}
			}
			c_eithel_celebros = {
				location = {
					culture = culture_druedain
					religion = religion_druedain
				}
			}

			# get all interior titles
			any_landed_title = {
				limit = {
					de_jure_liege_or_above = k_brethil
					NOT = { title = d_dimbar }
					NOT = { title = d_lithir_malduin }
					NOT = { de_jure_liege_or_above = d_dimbar }
					NOT = { de_jure_liege_or_above = d_lithir_malduin }
					higher_tier_than = baron
					is_not_owner_capital_province = yes
				}
				PREV = {
					grant_title_no_opinion = PREV
				}
			}

			# give kingdom
			k_brethil = {
				PREV = {
					grant_title_no_opinion = PREV
				}
			}

			# convert held provinces to haladin
			any_realm_province = {
				settle_with_root_refugees_effect = yes
			}

			# vassalize elves
			any_independent_ruler = {
				limit = {
					capital_scope = {
						de_jure_liege_or_above = k_brethil
						NOT = { de_jure_liege_or_above = d_dimbar }
						NOT = { de_jure_liege_or_above = d_lithir_malduin }
					}
					NOT = { religion = religion_wilderness }
				}
				set_defacto_liege = PREV
			}
			
			# abandon the old lands
			any_demesne_province = {
				limit = {
					NOT = { de_jure_liege_or_above = k_brethil }
				}
				abandon_province = yes
			}

			# set old subjects free
			any_demesne_province = {
				limit = {
					NOT = { de_jure_liege_or_above = k_brethil }
				}
				owner = { set_defacto_liege = THIS }
			}

			# notify players
			any_player = {
				character_event = { id = comingofmen.10 }
			}

			# set flag
			set_global_flag = coming_of_men_brethil
		}
	}
	option = {
		trigger = {
			ai = no
		}
		name = EVTOPTBcomingofmen.21
	}
}

# lord of doriath sends a letter
long_character_event = {
	id = comingofmen.22
	desc = EVTDESCcomingofmen.22
	picture = GFX_edain_meet_elves

	only_independent = yes
	has_global_flag = coming_of_men_edain

	trigger = {
		culture_group = culture_group_edain
		lower_tier_than = KING
		OR = {
			k_doriath = { has_holder = yes }
			e_eglador = { has_holder = yes }
		}

		# only receive an offer once per life
		NOT = { has_character_flag = edain_offered_settlement }

		capital_scope = {
			empire = {
				OR = {
					title = e_ossiriand
					title = e_harn_baland
				}
			}
		}
	}

	mean_time_to_happen = {
		years = 10
	}

	immediate = {
		set_character_flag = edain_offered_settlement

		random_list = {
			10 = {
				modifier = {
					has_global_flag = coming_of_men_farestolad
					factor = 0
				}
				d_farestolad = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_farestolad
				}
			}
			10 = {
				modifier = {
					has_global_flag = coming_of_men_harestolad
					factor = 0
				}
				d_harestolad = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_harestolad
				}
			}
			10 = {
				modifier = {
					has_global_flag = coming_of_men_talath_annui
					factor = 0
				}
				d_talath_annui = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_talath_annui
				}
			}
			10 = {
				modifier = {
					has_global_flag = coming_of_men_daertelaith
					factor = 0
				}
				d_daertelaith = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_daertelaith
				}
			}
			10 = {
				modifier = {
					has_global_flag = coming_of_men_dor_dinen
					factor = 0
				}
				d_dor_dinen = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_dor_dinen
				}
			}
			10 = {
				modifier = {
					has_global_flag = coming_of_men_dimbar
					factor = 0
				}
				d_dimbar = {
					save_event_target_as = target_settle_duchy
					set_global_flag = coming_of_men_dimbar
				}
			}
		}
	}

	option = {
		name = EVTOPTAcomingofmen.22
		
		add_trait = elf_friend

		hidden_tooltip = {

			# get all provinces (sans the player capital)
			any_landed_title = {
				limit = {
					de_jure_liege_or_above = event_target:target_settle_duchy
					higher_tier_than = baron
					is_not_player_capital_county = yes
				}
				PREV = {
					grant_title_no_opinion = PREV
				}
			}

			# give duchy
			event_target:target_settle_duchy = {
				PREV = {
					grant_title_no_opinion = PREV
				}
			}

			# abandon the old lands to the wood elves
			any_realm_province = {
				limit = {
					NOT = { de_jure_liege_or_above = event_target:target_settle_duchy }
				}
				abandon_province_to_wood_elves = yes
			}
		
			# settle the host
			any_realm_province = {
				settle_with_root_refugees_effect = yes
				build_tribal_effect = yes
			}
			capital_scope = {
				build_city_effect = yes
			}

			# notify players
			any_player = {
				limit = {
					NOT = { character = ROOT }
				}
				character_event = { id = comingofmen.13 }
			}
		}
	}
	option = {
		trigger = {
			ai = no
		}
		add_trait = stubborn
		prestige = 200
		name = EVTOPTBcomingofmen.22
	}
}

# THE FORODWAITH ARRIVE

province_event = {
	id = comingofmen.23
	
	hide_window = yes
	has_global_flag = coming_of_men_awakening
	
	trigger = {
		year = 4395
		NOT = { year = 4500 }
		OR = {
			region = custom_lothlann_steppe
			AND = {
				region = world_iron_mountains
				NOT = { religion_group = religion_group_melkor }
				NOT = { culture_group = culture_group_moriquendi }
			}
			AND = {
				region = world_ard_galen
				OR = {
					religion = religion_wilderness
					culture = culture_kul_uruk
				}
			}
			AND = {
				region = world_lothlann
				OR = {
					religion = religion_wilderness
					religion_group = religion_group_melkor
				}
			}
		}
		# exceptions
		NOT = { province_id = 189 }
		county = { is_not_player_capital_county = yes }
		NOT = { is_human_culture = yes }
	}

	mean_time_to_happen = {
		years = 10
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			religion = religion_lossoth
			culture = culture_lossoth
			female = no
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government
			}
			location = {
				culture = culture_lossoth
				religion = religion_lossoth

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						province = PREV

						troops = {
							archers = { 200 200 }
							light_infantry = { 400 400 }
							heavy_infantry = { 50 50 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}

	after = {
		# if this is the first time
		if = {
			limit = {
				NOT = { has_global_flag = coming_of_men_forodwaith }
			}
			any_player = {
				character_event = { id = comingofmen.2 }
			}
			set_global_flag = coming_of_men_forodwaith
		}
	}
}

# character is informed
character_event = {
	id = comingofmen.24

	is_triggered_only = yes
	
	hide_window = yes
	
	trigger = {
		NOT = { religion_group = religion_group_melkor }
	}

	option = {
		random = {
			chance = 20
			add_trait = man_friend
		}
	}
	
	option = {
		random = {
			chance = 20
			add_trait = zealous
		}
	}
}

# THE ANACHRIM SETTLE ANACH

province_event = {
	id = comingofmen.25
	
	hide_window = yes
	has_global_flag = coming_of_men_forodwaith

	trigger = {
		year = 4415
		NOT = { year = 4500 }
		region = custom_anach
		OR = {
			religion = religion_wilderness
			religion_group = religion_group_melkor
		}
		county = { is_not_player_capital_county = yes }
	}

	mean_time_to_happen = {
		years = 15
	}

	option = {
		build_tribal_effect = yes

		create_character = {
			religion = religion_anach
			culture = culture_anach
			female = no
		}

		county = {
			new_character = {
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government
			}
			location = {
				culture = culture_anach
				religion = religion_anach

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						province = PREV

						troops = {
							archers = { 100 100 }
							light_infantry = { 200 200 }
							heavy_infantry = { 50 50 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}

	after = {
		# if this is the first time
		if = {
			limit = {
				NOT = { has_global_flag = coming_of_men_anachrim }
			}
			any_player = {
				character_event = { id = comingofmen.3 }
			}
			set_global_flag = coming_of_men_anachrim
		}
	}
}

# THE BEODIN ARRIVE

province_event = {
	id = comingofmen.26
	
	hide_window = yes
	has_global_flag = coming_of_men_battle_of_palisor
	
	trigger = {
		year = 4595

		NOT = { has_global_flag = coming_of_men_beodin }
		is_edain_entry_province = yes
		county = { is_not_player_capital_county = yes }

		NOT = { is_human_culture = yes }
	}

	mean_time_to_happen = {
		years = 10
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			name = "Balan"
			dynasty = 15004
			religion = religion_edain
			culture = culture_beodin
			female = no
			trait = brave
			trait = just
			trait = selfish
			trait = rude
			trait = authoritative
			trait = gregarious
			trait = good_speaker
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				prestige = 500
				wealth = 200
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government

				create_bloodline = {
					type = balan
					#has_dlc = "Holy Fury"
				}
				set_character_flag = balan
			}
			location = {
				religion = religion_edain
				culture = culture_beodin

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						earmark = host_of_beor
						province = PREV

						troops = {
							archers = { 1200 1200 }
							light_infantry = { 1900 1900 }
							heavy_infantry = { 200 200 }
							light_cavalry = { 200 200 }
							pikemen = { 200 200 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}
	after = {
		set_global_flag = coming_of_men_beodin

		# if this is the first time
		if = {
			limit = {
				NOT = { has_global_flag = coming_of_men_edain }
			}
			any_player = {
				character_event = { id = comingofmen.5 }
			}
			set_global_flag = coming_of_men_edain
		}
	}
}

# THE MARADIN ARRIVE

province_event = {
	id = comingofmen.27
	
	hide_window = yes
	has_global_flag = coming_of_men_beodin
	
	trigger = {
		year = 4620

		NOT = { has_global_flag = coming_of_men_maradin }
		is_edain_entry_province = yes
		county = { is_not_player_capital_county = yes }

		NOT = { is_human_culture = yes }
	}

	mean_time_to_happen = {
		years = 20
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			name = "Marach"
			dynasty = 15005
			religion = religion_edain
			culture = culture_maradin
			female = no
			trait=poet
			trait=proud
			trait=stubborn
			trait=honorable
			trait=zealous
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				prestige = 500
				wealth = 200
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government
				set_character_flag = marach
			}
			location = {
				religion = religion_edain
				culture = culture_maradin

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						earmark = host_of_marach
						province = PREV

						troops = {
							archers = { 1800 1800 }
							light_infantry = { 2900 2900 }
							heavy_infantry = { 300 300 }
							light_cavalry = { 250 250 }
							pikemen = { 300 300 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}
	after = {
		set_global_flag = coming_of_men_maradin
	}
}

# THE HALETHRIM ARRIVE

province_event = {
	id = comingofmen.28
	
	hide_window = yes
	has_global_flag = coming_of_men_maradin
	
	trigger = {
		year = 4640

		NOT = { has_global_flag = coming_of_men_haladin }
		is_edain_entry_province = yes
		county = { is_not_player_capital_county = yes }

		NOT = { is_human_culture = yes }
	}

	mean_time_to_happen = {
		years = 20
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			name = "Haldad"
			age = 40
			dynasty = 15007
			religion = religion_edain
			culture = culture_haladin
			female = no
			trait=charismatic_negotiator
			trait=just
			trait=craven
			trait=kind
			trait=dwarf_friend
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				prestige = 500
				wealth = 200
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government

				set_character_flag = marach
			}
			location = {
				religion = religion_edain
				culture = culture_haladin

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						earmark = host_of_haldad
						province = PREV

						troops = {
							archers = { 1200 1200 }
							light_infantry = { 1400 1400 }
							heavy_infantry = { 400 400 }
							light_cavalry = { 50 50 }
							pikemen = { 200 200 }
						}
						attrition = 0.5
					}
					create_character = {
						name = "Haleth"
						age = 20
						dynasty = 15007
						father = PREV
						religion = religion_edain
						culture = culture_haladin
						female = yes
						trait=fair
						trait=proud
						trait=brave
						trait=quick
						trait=skilled_tactician
					}
					new_character = {
						prestige = 500
						wealth = 200
						create_bloodline = {
							type = haleth
							#has_dlc = "Holy Fury"
						}
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}
	after = {
		set_global_flag = coming_of_men_haladin
	}
}

# RANDOM EDAIN ARRIVE

province_event = {
	id = comingofmen.29
	
	hide_window = yes
	has_global_flag = coming_of_men_beodin

	trigger = {
		NOT = { year = 4700 }

		is_edain_entry_province = yes
		county = { is_not_player_capital_county = yes }

		NOT = { is_human_culture = yes }
	}

	mean_time_to_happen = {
		years = 70 # per province
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			religion = religion_edain
			culture = culture_beodin
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				prestige = 500
				wealth = 200
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government

				set_character_flag = marach
			}
			location = {
				religion = religion_edain
				random_list = {
					10 = { culture = culture_beodin }
					10 = { culture = culture_haladin }
					10 = { culture = culture_maradin }
					5 = { culture = culture_druedain }
				}

				owner = {
					culture = PREV

					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						province = PREV

						troops = {
							archers = { 500 500 }
							light_infantry = { 700 700 }
							heavy_infantry = { 200 200 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}
}

# pinging events
# The Awakening of Men
narrative_event = {
	id = comingofmen.30
	hide_window = yes

	only_independent = yes

	trigger = {
		has_landed_title = e_dor_daedeloth
        year = 4320
        NOT = { has_global_flag = coming_of_men_awakening }
	}

	mean_time_to_happen = {
		years = 20
	}
	
	option = {
		set_global_flag = coming_of_men_awakening

		any_player = {
			character_event = { id = comingofmen.1 }
		}
	}
}

# pinging events
# The Battle of Palisor
narrative_event = {
	id = comingofmen.31
	hide_window = yes

	only_independent = yes

	trigger = {
		has_landed_title = e_dor_daedeloth
        year = 4412
        NOT = { has_global_flag = coming_of_men_battle_of_palisor }
	}

	mean_time_to_happen = {
		years = 40
	}
	
	option = {
		set_global_flag = coming_of_men_battle_of_palisor

		any_player = {
			character_event = { id = comingofmen.4 }
		}
	}
}

# THE EASTERLINGS ARRIVE
province_event = {
	id = comingofmen.32
	hide_window = yes

	has_global_flag = coming_of_men_edain

	trigger = {
        year = 4680
		NOT = { year = 4720 }
		region = custom_lothlann_steppe

		# exceptions
		NOT = { province_id = 189 } # c_amon_draug
		county = { is_not_player_capital_county = yes }
		NOT = { religion = religion_easterlings }
	}
	mean_time_to_happen = {
		years = 10
	}
	
	option = {
		build_tribal_effect = yes

		create_character = {
			religion = religion_easterlings
			culture = culture_baradhrim
			female = no
		}

		owner = {
			character_event = { id = comingofmen.24 }
		}

		county = {
			new_character = {
				usurp_title = PREV
				set_defacto_liege = THIS

				set_government_type = tribal_government
			}
			location = {
				culture = culture_baradhrim
				religion = religion_easterlings

				owner = {
					spawn_unit = {
						owner = THIS
						leader = THIS
						maintenance = no
						province = PREV

						troops = {
							archers = { 200 200 }
							light_infantry = { 400 400 }
							light_cavalry = { 1000 1000 }
							horse_archers = { 800 800 }
						}
						attrition = 0.5
					}
				}
			}
		}

		populate_effect = yes
		add_province_modifier = {
			name = settled_by_refugees
			duration = 7300
		}
	}

	after = {
		# if this is the first time
		if = {
			limit = {
				NOT = { has_global_flag = coming_of_men_easterlings }
			}
			any_player = {
				character_event = { id = comingofmen.6 }
			}
			set_global_flag = coming_of_men_easterlings
		}
	}
}

# I can offer service to a strong mannish lord
character_event = {
	id = comingofmen.33
	title = EVTTITcomingofmen.33
	desc = EVTDESCcomingofmen.33
	picture = GFX_elf_noldor

	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.33
		set_character_flag = offered_edain_service

		event_target:target_edain_offer_target = {
			letter_event = { id = comingofmen.35 days = 5 }
		}
	}

	option = {
		name = EVTOPTBcomingofmen.33
	}
}

# I can offer an entire high lordship to a strong mannish lord
character_event = {
	id = comingofmen.34
	title = EVTTITcomingofmen.34
	desc = EVTDESCcomingofmen.34
	picture = GFX_elf_noldor

	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.34
		set_character_flag = offered_edain_vassalage

		event_target:target_edain_offer_target = {
			letter_event = { id = comingofmen.36 days = 5 }
		}
	}

	option = {
		name = EVTOPTBcomingofmen.34
	}
}

# letter offer of service
letter_event = {
	id = comingofmen.35
	desc = EVTDESCcomingofmen.35
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.35
		reverse_opinion = { who = FROM modifier = opinion_very_grateful }

		# join the elves
		event_target:target_edain_offer_title = {
			set_title_flag = temporary_edain_title
			location = {
				culture = ROOT
				religion = ROOT
				build_tribal_effect = yes
				populate_effect = yes
				increase_depopulation_effect = yes
			}
			PREV = {
				usurp_title = PREV
			}
		}
		set_defacto_liege = FROM
		add_trait = elf_friend
		change_martial = 2
		set_character_flag = vassalage_ends_on_death
	}
	option = {
		trigger = { ai = no }
		name = EVTOPTBcomingofmen.35
		reverse_opinion = { who = FROM modifier = opinion_insulted }
	}
}

# letter offer of vassalage
letter_event = {
	id = comingofmen.36
	desc = EVTDESCcomingofmen.36
	is_triggered_only = yes

	option = {
		name = EVTOPTAcomingofmen.36
		reverse_opinion = { who = FROM modifier = opinion_very_grateful }

		# join the elves
		event_target:target_edain_offer_title = {
			any_de_jure_vassal_title = {
				location = {
					culture = ROOT
					religion = ROOT
					build_tribal_effect = yes
					populate_effect = yes
					increase_depopulation_effect = yes
				}
				PREVPREV = {
					usurp_title = PREV
				}
			}
			PREV = {
				usurp_title = PREV
			}
		}
		set_defacto_liege = FROM
		add_trait = elf_friend
		change_martial = 2
		create_bloodline = {
			type = pure_war_bloodline_01
			#has_dlc = "Holy Fury"
		}
	}
	option = {
		trigger = { ai = no }
		name = EVTOPTBcomingofmen.36
		reverse_opinion = { who = FROM modifier = opinion_insulted }
	}
}

# pinging events
# I should offer service or vassalage to one of the edain
narrative_event = {
	id = comingofmen.37
	hide_window = yes

	only_independent = yes
	has_global_flag = coming_of_men_edain

	trigger = {
		NOT = {
			AND = {
				has_character_flag = offered_edain_service
				has_character_flag = offered_edain_vassalage
			}
		}
		demesne_size = 2 # so I can give something away
		higher_tier_than = DUKE
		OR = {
			religion = religion_calaquendi # on the frontlines
			trait = man_friend
		}
		any_independent_ruler = {
			AND = {
				religion = religion_edain
				higher_tier_than = COUNT
				lower_tier_than = KING
				mercenary = no
				holy_order = no
				age = 16
			}
		}
		OR = {
			# one of the two options need to be possible
			NOT = { has_character_flag = offered_edain_service }
			any_realm_province = {
				AND = {
					duchy = {
						ROOT = {
							capital_scope = {
								duchy = {
									# not the capital duchy
									NOT = { title = PREVPREVPREV }
								}
							}
						}
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		years = 4
	}

	immediate = {
		random_independent_ruler = {
			limit = {
				AND = {
					religion = religion_edain
					higher_tier_than = COUNT
					lower_tier_than = KING
					mercenary = no
					holy_order = no
					age = 16
				}
			}
			save_event_target_as = target_edain_offer_target
		}
	}

	option = {
		trigger = {
			NOT = { has_character_flag = offered_edain_service }
		}

		random_demesne_title = {
			limit = {
				tier = COUNT
				ROOT = {
					capital_scope = {
						county = {
							# not the capital county
							NOT = { title = PREVPREVPREV }
						}
					}
				}
			}
			save_event_target_as = target_edain_offer_title
		}

		character_event = { id = comingofmen.33 }
	}

	option = {
		trigger = {
			has_character_flag = offered_edain_service
			NOT = { has_character_flag = offered_edain_vassalage }

			any_realm_province = {
				AND = {
					duchy = {
						ROOT = {
							capital_scope = {
								duchy = {
									# not the capital duchy
									NOT = { title = PREVPREVPREV }
								}
							}
						}
					}
				}
			}
		}

		random_realm_province = {
			limit = {
				duchy = {
					ROOT = {
						capital_scope = {
							duchy = {
								# not the capital duchy
								NOT = { title = PREVPREVPREV }
							}
						}
					}
				}
			}
			duchy = {
				save_event_target_as = target_edain_offer_title
			}
		}

		character_event = { id = comingofmen.34 }
	}
}

# The mannish servant dies. His descendant can decide to be a permanent vassal, or leave service of the elf-lord
character_event = {
	id = comingofmen.38
	desc = EVTDESCcomingofmen.38
	picture = GFX_edain_death
	
	has_character_flag = end_vassalage

	mean_time_to_happen = {
		months = 1
	}

	immediate = {
		clr_character_flag = end_vassalage
	}

	option = {
		trigger = {
			OR = {
				NOT = { trait = zealous }
				ai = no
			}
		}
		name = EVTOPTAcomingofmen.38
		remove_trait = zealous
		add_trait = elf_friend
	}

	option = {
		name = EVTOPTBcomingofmen.38

		# leave service of the elves
		any_demesne_title = {
			limit = {
				has_title_flag = temporary_edain_title
			}
			clr_title_flag = temporary_edain_title
			location = {
				remove_tribal_effect = yes
				ROOT = {
					liege = {
						PREVPREV = { # TODO not working?
							culture = PREV
							religion = PREV
						}
					}
				}
			}
			any_de_jure_vassal_title = {
				ROOT = {
					liege = {
						usurp_title = PREVPREV
					}
				}
			}
			ROOT = {
				liege = {
					usurp_title = PREVPREV
				}
			}
		}
		set_defacto_liege = THIS
	}
}

# on_death event (end vassalage)
character_event = {
	id = comingofmen.39
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_character_flag = vassalage_ends_on_death
		any_liege = {
			religion_group = religion_group_eldar
		}
	}

	immediate = {
		current_heir = {
			set_character_flag = end_vassalage
		}
	}
}

# on_death event (end elf friendship)
character_event = {
	id = comingofmen.40
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		religion = religion_edain
		trait = elf_friend
	}

	immediate = {
		current_heir = {
			set_character_flag = gain_elf_friend
		}
	}
}

# on_death event (end dwarf friendship)
character_event = {
	id = comingofmen.41
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		religion = religion_edain
		trait = dwarf_friend
	}

	immediate = {
		current_heir = {
			set_character_flag = gain_dwarf_friend
		}
	}
}

# your predecessor was an elf-friend. Are you? (this prevents elves from attacking you unjustly)
character_event = {
	id = comingofmen.42
	desc = EVTDESCcomingofmen.42
	picture = GFX_death
	
	has_character_flag = gain_elf_friend

	mean_time_to_happen = {
		months = 1
	}

	immediate = {
		clr_character_flag = gain_elf_friend
	}

	option = {
		trigger = {
			OR = {
				NOT = { trait = zealous }
				ai = no
			}
		}
		name = EVTOPTAcomingofmen.42

		add_trait = elf_friend
	}

	option = {
		name = EVTOPTBcomingofmen.42
		trigger = {
			OR = {
				trait = zealous
				ai = no
			}
		}

		# leave friendship of the elves
		remove_trait = elf_friend
	}
}

# your predecessor was a dwarf-friend. Are you? (this prevents dwarves from attacking you unjustly)
character_event = {
	id = comingofmen.43
	desc = EVTDESCcomingofmen.43
	picture = GFX_death
	
	has_character_flag = gain_dwarf_friend

	mean_time_to_happen = {
		months = 1
	}

	immediate = {
		clr_character_flag = gain_dwarf_friend
	}

	option = {
		trigger = {
			OR = {
				NOT = { trait = zealous }
				ai = no
			}
		}
		name = EVTOPTAcomingofmen.43

		add_trait = dwarf_friend
	}

	option = {
		name = EVTOPTBcomingofmen.43
		trigger = {
			OR = {
				trait = zealous
				ai = no
			}
		}

		# leave friendship of the dwarves
		remove_trait = dwarf_friend
	}
}
