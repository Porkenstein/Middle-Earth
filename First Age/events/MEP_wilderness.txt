namespace = colonisation

# TODO: store the ID of the province from which colonists are being sent in a variable, then reference it to set the colonized province to that culture and religion

# colonise 
character_event = {
	id = colonisation.0
	hide_window = yes

	capable_only = yes
	prisoner = no
	has_job_title = yes
	
	trigger = {
		has_job_action = action_colonize_province
		location = {
			county = {
				is_occupied = no
			}
			owner = {
				job_treasurer = {
					character = ROOT
				}
			}
		}
	}

	mean_time_to_happen = {
        years = 1
        modifier = {
            factor = 2 # Dwarves are slow
            location = { owner = { religion_group = religion_group_khazad } }
        }
        modifier = {
            factor = 4 # Elves are slower
            location = { owner = { religion_group = religion_group_eldar } }
        }
        modifier = {
            factor = 2 # Initial population is costly
            location = { has_province_modifier = depopulated_3 }
        }
        modifier = {
            factor = 2 # More slow when no settlement
            location = { NOT = { num_of_settlements = 1 } }
        }
        modifier = {
            factor = 2 # Fully populated provinces with only one holding take a while
            location = {
				NOT = { num_of_settlements = 2 }
				has_province_modifier = depopulated_1
			}
        }
        modifier = {
            factor = 0.8 # faster colonisation from prospering capitals
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = prosperity_modifier_1
					}
				}
			}
        }
		modifier = {
            factor = 0.7 # faster colonisation from prospering capitals
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = prosperity_modifier_2
					}
				}
			}
        }
		modifier = {
            factor = 0.6 # faster colonisation from prospering capitals
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = prosperity_modifier_3
					}
				}
			}
        }
        modifier = {
            factor = 2 # depopulated capitals can't colonise as fast
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = depopulated_1
					}
				}
			}
        }
		modifier = {
            factor = 3 # depopulated capitals can't colonise as fast
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = depopulated_2
					}
				}
			}
        }
		modifier = {
            factor = 4 # depopulated capitals can't colonise as fast
            location = {
				owner = {
					capital_scope = {
						has_province_modifier = depopulated_3
					}
				}
			}
        }
	}

	option = {
		# bump population
		location = {
			# if this is initial population, update this province with the source province's culture and race
			if = {
				limit = {
					has_province_modifier = depopulated_3
				}
				owner = {
					PREV = {
						culture = PREV
						religion = PREV
					}
				}
			}

			# reduce depopulation, set colonisation flag
			colonise = yes

			# the steward receives an event if colonisation is finished
			if = {
				limit = {
					NOT = { has_depopulation_effect = yes }
				}
				ROOT = {
					character_event = { id = colonisation.1 }
				}
			}
		}
	}
}


 # The steward receives an event
 character_event = {
 	id = colonisation.1
	is_triggered_only = yes

 	desc = "colonisation6desc"
 	picture = GFX_edain_travel
 	
 	option = {
 		name = "colonisation6A"
 		liege = { letter_event = { id = colonisation.2 days = 7 } }
 	}
 }
 
 # The liege is informed
 letter_event = {
 	id = colonisation.2
	is_triggered_only = yes

 	desc = "colonisation3desc"
 	
 	option = {
 		name = "colonisation3A"
 	}
 }

########################
# ambitious courtier builds a barony, populates the province with his race & culture, and becomes your vassal here
########################

# steward's efforts are noticed
character_event = {
	id = colonisation.7
	desc = "colonisation7desc"
	picture = GFX_elf_noldor

	capable_only = yes
	prisoner = no
	has_job_title = yes
	
	trigger = {
		has_job_action = action_colonize_province
		location = { NOT = { num_of_settlements = 1 } } # must be an empty province
		liege = { higher_tier_than = COUNT } # this character can't be your vassal if he's landed and you're only a count
	}
	
	mean_time_to_happen = {
		years = 10
	}
	
	option = {
		name = "colonisation7A"
		liege = {
			random_courtier = { # if nobody fits the bill, so be it
				limit = {
					# "...dreamed of a realm of our own..."
					OR = {
						is_landed = no
						tier = BARON
					}
					OR = {
						is_female = no
						trait = ambitious
					}
					# "long have my folk and I..."
					OR = {
						AND = {
							NOT = { trait = elf }
							age = 40
						}
						AND = {
							trait = elf
							age = 200
						}
					}
					#is_capable_in_court = yes
					NOT = { has_character_flag = flag_refused_colonisation }
					NOT = { trait = content }
				}
				character_event = { id = colonisation.8 }
			}
		}
	}
}

# bounce off the unlanded subject
character_event = {
	id = colonisation.8
	hide_window = yes
	
	is_triggered_only = yes
	
	option = {
		liege = { letter_event = { id = colonisation.9 } }
	}
}

# the liege is asked by the unlanded subject
letter_event = {
	id = colonisation.9
	desc = "colonisation9desc"
	
	is_triggered_only = yes
	
	option = { # no
		name = "colonisation9A"
		FROM = {
			opinion = { modifier = opinion_very_disappointed who = ROOT years = 2 }
			set_character_flag = flag_refused_colonisation
		}
	}
	
	option = { # yes
		name = "colonisation9B"
		
		random_demesne_province = { # build a castle and grant the county
			limit = {
				ROOT = { job_treasurer = { location = { province = PREVPREVPREV } } }
				NOT = { num_of_settlements = 1 }
			}
			build_holding = { type = castle holder = FROM }
			colonise = yes
			
			culture = FROM
			religion = FROM
		}
		FROM = {
			opinion = { modifier = opinion_very_grateful who = ROOT years = 2 }
			set_defacto_liege = ROOT
		}
	}
	
	option = { # for a favor
		tooltip_info = diplomacy
		name = "colonisation9C"
		
		trigger = {
			diplomacy = 15
		}
		
		random_demesne_province = { # build a castle and grant the county
			limit = {
				ROOT = { job_treasurer = { location = { province = PREVPREVPREV } } }
				NOT = { num_of_settlements = 1 }
			}
			build_holding = { type = castle holder = FROM }
			colonise = yes
			
			culture = FROM
			religion = FROM
		}
		FROM = {
			opinion = { modifier = opinion_grateful who = ROOT years = 1 }
			set_defacto_liege = ROOT
		}
		add_favor = FROM
	}
}


###################################################################################
## AI won't use targetted decisions properly.  Have them colonise via event instead
###################################################################################
########################
# AI colonisation events
########################

# look for a wilderness to claim, if I can/want to
character_event = {
	id = colonisation.10
	hide_window = yes
	
	is_triggered_only = yes

	ai = yes
	only_playable = yes

	trigger = {
		is_incapable = no
		NOT = { government = nomadic_government }
		NOT = { religion = religion_umaiar } # umaiar AI characters auto-claim every adjacent wilderness (colonisation.11)
		NOT = { religion_group = religion_group_wilderness }
		NOT = {	ROOT = { has_character_flag = no_settling } }
		OR = {
			has_character_flag = flag_expanding
			AND = {
				prestige = 200
				wealth = 0
			}
		}
		OR = {
			AND = {
				trait = ambitious
				independent = yes
			}
			trait = oath_of_feanor
			has_character_flag = flag_expanding
			is_human_culture = yes
		}

		# dwarves send mining expeditions instead
		NOT = { culture_group = culture_group_dwarves }
	}

	option = {
		random_neighbor_independent_ruler = {
			limit = {
				religion_group = religion_group_wilderness
				war = no # not being colonised

				OR = {
					# only certain AI groups should try colonising lothlann
					location = {
						NOT = { is_unattractive_colonisation_target = yes }
					}
					ROOT = { is_human_culture = yes	}
				}
			}
			ROOT = {
				scaled_prestige = -3.0
				scaled_wealth = -0.75
			}
			capital_holding = {
				county = {
					usurp_title = { target = ROOT type = claim } # gain control of the province
				}
				destroy_settlement = THIS # remove the wilderness barony
			}
		}
	}

	option = {
		# nothing happens
	}
}

# claim everything! muahaha
character_event = {
	id = colonisation.11
	hide_window = yes
	
	is_triggered_only = yes

	ai = yes
	only_playable = yes

	trigger = {
		is_incapable = no
		NOT = { government = nomadic_government }
		religion = religion_umaiar
		has_global_flag = broken_siege_of_angband
		NOT = {	has_character_flag = no_settling }
		year = 4400 # don't start overrunning everything until we have enough manpower (not before the siege of angband, unless the siege never happens)
	}

	option = {
		random_neighbor_independent_ruler = {
			limit = {
				religion_group = religion_group_wilderness
			}
			capital_holding = {
				county = {
					usurp_title = { target = ROOT type = claim } # gain control of the province
				}
				destroy_settlement = THIS # remove the wilderness barony
			}
		}
	}
}

# AI men colonise lands via event, not jobs

character_event = {
	id = colonisation.12
	hide_window = yes

	ai = yes
	only_playable = yes

	trigger = {
		is_human_culture = yes
		any_demesne_province = {
			num_of_settlements = 1
			has_depopulation_effect = yes
		}
	}
	mean_time_to_happen = {
		years = 1
	}
	option = {
		random_demesne_province = {
			decrease_depopulation_effect = yes
		}
	}
}
